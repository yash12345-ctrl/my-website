<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Network Scanner | Professional IoT Analysis</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 
            0% { opacity: 0.5; } 
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7f9;
            color: #333;
            /* Prevents horizontal scrolling while allowing vertical */
            overflow-x: hidden;
        }
        
        .app-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 100vh;
        }

        .left-panel {
            background-color: #ffffff;
            padding: 40px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.05);
            z-index: 10;
            border-right: 1px solid #e7eaf3;
        }
        
        .right-panel {
            padding: 40px;
            overflow-y: auto;
            height: 100vh;
        }

        h1 {
            font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; color: #111;
        }
        h1 .fa-bluetooth-b { color: #007bff; }
        .subtitle { color: #666; margin-bottom: 20px; font-weight: 400; font-size: 1.1rem; }
        .description { font-size: 0.95rem; color: #777; line-height: 1.6; margin-bottom: 40px; }

        #scanButton {
            width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 500;
            color: #fff; background-color: #007bff;
            border: none; border-radius: 8px; cursor: pointer;
            transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        #scanButton.scanning {
            background-color: #dc3545; /* Red for stop button */
        }
        #scanButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        #scanButton:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #scanButton .fa-spin { display: none; }

        .status-box {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #e7eaf3;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #555;
            text-align: center;
        }
        .status-box.scanning {
            animation: pulse 2s infinite;
            font-weight: 500;
        }

        #deviceList {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .device-card {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e7eaf3;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            animation: fadeIn 0.5s ease;
            position: relative;
        }
        .device-card h3 {
            font-size: 1.1rem; font-weight: 600; color: #333;
            margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px;
        }
        .device-card p {
            font-size: 0.85rem;
            color: #777;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .device-card .rssi {
            position: absolute;
            top: 20px; right: 20px;
            font-size: 1rem;
            color: #555;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .device-card .connect-btn {
            margin-top: 15px; width: 100%; padding: 10px;
            background-color: #28a745; color: white; border: none;
            border-radius: 8px; cursor: pointer; transition: background-color 0.3s;
        }
        .device-card .connect-btn:hover { background-color: #218838; }
        .device-card .connect-btn:disabled { background-color: #a0a0a0; }

        .device-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .device-details strong { font-size: 0.9rem; color: #444; }
        .device-details ul { list-style: none; padding: 0; margin-top: 5px; }
        .device-details li { font-size: 0.85rem; color: #666; padding: 4px 0; }

        .error-message { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid rgba(220, 53, 69, 0.2); }

        /* --- Responsive Styles --- */
        
        /* For tablets and smaller laptops */
        @media (max-width: 1024px) {
            .app-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            .left-panel {
                box-shadow: none;
                border-bottom: 1px solid #e7eaf3;
                padding: 30px;
                border-right: none;
            }
            .right-panel {
                height: auto;
                overflow-y: visible; /* Let the body handle scrolling */
                padding: 30px;
            }
            h1 {
                font-size: 2.2rem;
            }
        }
        
        /* For mobile phones */
        @media (max-width: 768px) {
            .left-panel, .right-panel {
                padding: 20px;
            }
            h1 {
                font-size: 1.8rem;
            }
            .subtitle {
                font-size: 1rem;
            }
            #scanButton {
                padding: 12px;
                font-size: 1rem;
            }
            /* Force device cards into a single column on mobile */
            #deviceList {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        /* For very small screens */
        @media (max-width: 480px) {
             .left-panel, .right-panel {
                padding: 15px;
            }
            .device-card {
                padding: 15px;
            }
            .device-card h3 {
                font-size: 1rem;
            }
             .device-card p {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <main class="app-layout">
        <div class="left-panel">
            <h1>BLE Scanner <i class="fa-brands fa-bluetooth-b"></i></h1>
            <p class="subtitle">Discover and Analyze Nearby Devices</p>
            <p class="description">
                Press "Start Scan" to continuously search for nearby Bluetooth devices. Some devices advertise intermittently, so a longer scan may be needed. Press "Stop Scan" when you are finished.
            </p>

            <button id="scanButton">
                <i class="fa-solid fa-satellite-dish"></i>
                <i class="fa-solid fa-square-xmark" style="display: none;"></i>
                <span>Start Scan</span>
            </button>
            <div id="statusBox" class="status-box">Ready to scan...</div>
            <div id="errorBox" class="error-message" style="display: none;"></div>
        </div>
        <div class="right-panel">
            <div id="deviceList">
                </div>
        </div>
    </main>
    
    <script>
        'use strict';
        const scanButton = document.getElementById('scanButton');
        const statusBox = document.getElementById('statusBox');
        const errorBox = document.getElementById('errorBox');
        const deviceList = document.getElementById('deviceList');
        const scanIcon = scanButton.querySelector('.fa-satellite-dish');
        const stopIcon = scanButton.querySelector('.fa-square-xmark');
        const scanText = scanButton.querySelector('span');

        let discoveredDevices = new Map();
        let scan = null;
        let isScanning = false;

        if (!navigator.bluetooth) {
            showError("Web Bluetooth API is not available on this browser. Please use Chrome or Edge.");
            scanButton.disabled = true;
        }

        scanButton.addEventListener('click', async () => {
            if (isScanning) {
                stopScan();
                return;
            }

            discoveredDevices.clear();
            deviceList.innerHTML = '';
            showError(null);
            
            try {
                updateScanButton(true, 'Stop Scan');
                
                scan = await navigator.bluetooth.requestLEScan({ acceptAllAdvertisements: true });
                updateStatus('Scanning continuously...');
                
                navigator.bluetooth.addEventListener('advertisementreceived', handleAdvertisement);
                isScanning = true;

            } catch(error) {
                showError(`Scan failed: ${error.message}`);
                updateScanButton(false, 'Start Scan');
            }
        });

        function handleAdvertisement(event) {
            if (!discoveredDevices.has(event.device.id)) {
                console.log('Found device:', event.device.name, event.device.id, event.rssi);
                discoveredDevices.set(event.device.id, event.device);
                addDeviceCard(event.device, event.rssi);
                updateStatus(`Found ${discoveredDevices.size} device(s)... Still scanning.`);
            } else {
                const rssiElement = document.querySelector(`#device-${event.device.id} .rssi-value`);
                if (rssiElement) rssiElement.textContent = `${event.rssi} dBm`;
            }
        }

        function stopScan() {
            if (scan) {
                scan.stop();
                scan = null;
                navigator.bluetooth.removeEventListener('advertisementreceived', handleAdvertisement);
            }
            isScanning = false;
            updateScanButton(false, 'Start Scan');
            updateStatus(`Scan stopped. Found ${discoveredDevices.size} total device(s).`);
        }

        function addDeviceCard(device, rssi) {
            const card = document.createElement('div');
            card.className = 'device-card';
            card.id = `device-${device.id}`;
            
            let deviceName = device.name || 'Unknown Device';
            let deviceTypeIcon = 'fa-microchip';
            if (deviceName.toLowerCase().includes('esp32')) deviceTypeIcon = 'fa-wifi';
            if (deviceName.toLowerCase().includes('neo-')) deviceTypeIcon = 'fa-location-crosshairs';

            card.innerHTML = `
                <h3><i class="fa-solid ${deviceTypeIcon}"></i> ${deviceName}</h3>
                <p>ID: ${device.id}</p>
                <div class="rssi">
                    <i class="fa-solid fa-signal"></i>
                    <span class="rssi-value">${rssi || 'N/A'} dBm</span>
                </div>
                <button class="connect-btn" onclick="connectToDevice('${device.id}')">Connect & Read Info</button>
                <div class="device-details" id="details-${device.id}"></div>
            `;
            deviceList.appendChild(card);
        }

        async function connectToDevice(deviceId) {
            if(isScanning) {
                stopScan();
            }

            const device = discoveredDevices.get(deviceId);
            if (!device) { showError('Device not found.'); return; }

            const detailsDiv = document.getElementById(`details-${deviceId}`);
            const connectBtn = document.querySelector(`#device-${deviceId} .connect-btn`);

            try {
                connectBtn.disabled = true;
                connectBtn.textContent = 'Connecting...';
                updateStatus(`Requesting connection to ${device.name || device.id}...`);

                const server = await device.gatt.connect();
                
                updateStatus(`Connected! Reading services...`);

                let detailsHTML = '<strong>Services & Characteristics:</strong><ul>';
                try {
                    const deviceInfoService = await server.getPrimaryService('device_information');
                    const modelNumber = await readCharacteristic(deviceInfoService, 'model_number_string');
                    const manufacturer = await readCharacteristic(deviceInfoService, 'manufacturer_name_string');
                    if (modelNumber) detailsHTML += `<li>Model: ${modelNumber}</li>`;
                    if (manufacturer) detailsHTML += `<li>Manufacturer: ${manufacturer}</li>`;
                } catch(e) { /* Service not found */ }
                
                try {
                    const batteryService = await server.getPrimaryService('battery_service');
                    const batteryLevel = await readCharacteristic(batteryService, 'battery_level');
                    if (batteryLevel) detailsHTML += `<li>Battery: ${batteryLevel}%</li>`;
                } catch(e) { /* Service not found */ }

                detailsHTML += '</ul>';
                detailsDiv.innerHTML = detailsHTML;
                connectBtn.textContent = 'Disconnect';
                connectBtn.style.backgroundColor = '#dc3545';
                connectBtn.onclick = () => {
                    if (server.connected) server.disconnect();
                    updateStatus(`Disconnected from ${device.name || device.id}`);
                    connectBtn.textContent = 'Connect & Read Info';
                    connectBtn.style.backgroundColor = '#28a745';
                    detailsDiv.innerHTML = '';
                    connectBtn.onclick = () => connectToDevice(deviceId);
                };
            } catch(error) {
                showError(`Connection failed: ${error.message}`);
                connectBtn.textContent = 'Connection Failed';
            } finally {
                connectBtn.disabled = false;
            }
        }
        
        async function readCharacteristic(service, characteristicUUID) {
            try {
                const characteristic = await service.getCharacteristic(characteristicUUID);
                const value = await characteristic.readValue();
                if (characteristicUUID === 'battery_level') return value.getUint8(0);
                const decoder = new TextDecoder('utf-8');
                return decoder.decode(value);
            } catch (error) {
                console.warn(`Could not read characteristic ${characteristicUUID}: ${error.message}`);
                return null;
            }
        }

        function updateScanButton(scanning, text) {
            scanButton.classList.toggle('scanning', scanning);
            scanIcon.style.display = scanning ? 'none' : 'inline-block';
            stopIcon.style.display = scanning ? 'inline-block' : 'none';
            scanText.textContent = text;
        }

        function updateStatus(message) {
            statusBox.textContent = message;
            statusBox.classList.toggle('scanning', isScanning);
        }

        function showError(message) {
            errorBox.style.display = message ? 'block' : 'none';
            errorBox.textContent = message;
        }
    </script>
</body>
</html>